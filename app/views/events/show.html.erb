<% if @event.photo_banner.attached? %>
  <%= cl_image_tag @event.photo_banner.key, class: "card-image img-fluid mt-2", crop: :fill %>
<% else %>
  <div class="card-image d-flex justify-content-center align-items-center mt-2"><span>Pas d'image disponible</span></div>
<% end %>

<div class="event-infos">
  <h2 class="mt-3"><%= @event.title %></h2>
  <p class="text-center">
    <% if @event.start_at && @event.end_at && @event.start_at != @event.end_at %>
      <span class="title-bold">DU <%= @event.start_at.strftime('%d/%m/%Y') %> AU <%= @event.end_at.strftime('%d/%m/%Y') %></span>
    <% elsif @event.start_at && @event.end_at  %>
      <span class="title-bold">LE <%= @event.start_at.strftime('%d/%m/%Y') %></span>
    <% else %>
      <span class="title-bold">DATE A DEFINIR</span>
    <% end %>
  </p>

  <% current_user_event =  UserEvent.find_by(event: @event, user: current_user) %>
  <% unless current_user_event.planner %>
  <!-- Boutons de participation / modifier les chemins -->
    <div class="d-flex justify-content-center mb-4">
        <% if current_user_event.status == "going" %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn-active mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
        <% elsif current_user_event.status == "maybe" %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn-active mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
        <% elsif current_user_event.status == "can't go" %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn-active mx-2" %>
        <% else %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
        <% end %>
    </div>
  <% end %>

  <div class="text-center mb-4">
    <%= link_to new_event_user_event_path(event_id: @event.id), class: "link text-bold" do %>
      <%= "#{pluralize(@event.user_events.where(status: 'going').count, 'participant')} - #{pluralize(@event.user_events.where(status: 'maybe').count, 'intéressé')}" %>
      <span><i class="fa-solid fa-user-plus"></i></span>
    <% end %>
  </div>

  <% planners = @event.user_events.where(planner: true) %>
  <p class="mb-3"><i class="fa-solid fa-user"></i> Organisé par
    <% planners.each do |planner| %>
      <% if planner == planners.last %>
        <%= "#{planner.user.first_name}" %>
      <% else %>
        <%= "#{planner.user.first_name}," %></p>
      <% end %>
    <% end %>
  </p>

  <p class="mb-3">
    <i class="fa-solid fa-location-dot"></i>
    <% if @event.place.present? %>
      <%= @event.place %>
    <% else %>
      Lieu à définir
    <% end %>
  </p>

  <!-- Partager l evenement -->

  <div class="mb-3">
    <%= link_to new_event_survey_path(@event), class: "link" do %>
      <i class="fa-solid fa-circle-plus"></i> Créer un nouveau sondage
    <% end %>
  </div>

  <% if @event.user_events.where(planner: true) %>
    <div class="mb-3">
      <%= link_to new_event_todo_list_path(@event), class: "link" do %>
        <i class="fa-solid fa-circle-plus"></i> Créer une to-do list
      <% end %>
    </div>
  <% end %>

  <div class="mt-4">
    <% @event.surveys.each do |survey| %>
      <% if !survey.answers.present? %>
        <% if @event.user_events.where(planner: true) == current_user or survey.user == current_user %>
          <div class="mb-3 survey-card">
            <%= link_to survey_path(survey), class: "link d-flex justify-content-between" do %>
              <div>
                <p><%= survey.question %></p>
                <p class="text-danger">Sondage à compléter</p>
              </div>
              <div class="text-center chevron">
                <i class="fa-solid fa-chevron-right"></i>
              </div>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="mb-3 survey-card">
          <%= link_to survey_path(survey), class: "link d-flex justify-content-between" do %>
              <div>
                <p class="survey-question"><%= survey.question %></p>
                <% if survey.deadline < Date.today %>
                  <p class="survey-infos">Sondage terminé <i class="fa-solid fa-check text-success"></i></p>
                <% elsif survey.deadline > Date.today %>
                  <p class="survey-infos"><i class="fa-solid fa-hourglass-start"></i> Fin du sondage dans <%= pluralize((survey.deadline - Date.today).to_i, "jour") %></p>
                <% else %>
                  <p class="survey-infos"><i class="fa-solid fa-hourglass-half"></i> Fin du sondage aujourd'hui</p>
                <% end %>
              </div>
              <div class="text-center chevron">
                <i class="fa-solid fa-chevron-right"></i>
              </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <% @event.todo_lists.each do |todo| %>
      <div class="mb-3 survey-card">
        <%= link_to "#{todo.title}", todo_list_path(todo), class: "link" %>
      </div>
    <% end %>
  </div>


  <h3 class="mt-5 mb-2">Description</h3>
  <p><%= @event.description %></p>
</div>
