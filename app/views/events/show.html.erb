<%# photo de l'évènement %>
<% if @event.photo_banner.attached? %>
  <%= cl_image_tag @event.photo_banner.key, class: "card-image img-fluid mt-2", crop: :fill %>
<% else %>
  <div class="card-image d-flex justify-content-center align-items-center mt-2"><span>Pas d'image disponible</span></div>
<% end %>

<%# Titre + Dates %>


<%= render 'modals/edit_dates' %>


<div class="event-infos">
  <h2 class="mt-3"><%= @event.title %></h2>
  <%= render "shared/show/edit_date" %>

<%# Participants %>
<%# choix %>
  <% current_user_event = UserEvent.find_by(event: @event, user: current_user) %>
  <% unless current_user_event.planner %>
    <div class="d-flex justify-content-center mb-4">
        <% if current_user_event.status == "going" %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn-active mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
        <% elsif current_user_event.status == "maybe" %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn-active mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
        <% elsif current_user_event.status == "can't go" %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn-active mx-2" %>
        <% else %>
          <%= link_to "Intéressé(e)", set_interested_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Participe", set_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
          <%= link_to "Ne participe pas", set_not_going_event_path(@event), data: { turbo_method: :patch }, class: "status-btn mx-2" %>
        <% end %>
    </div>
  <% end %>

<%# résultats (nb invités, nb participants, nb intéressés) %>
  <div class="text-center mb-4">
    <%= link_to new_event_user_event_path(event_id: @event.id), class: "link text-bold" do %>
      <% guests_count = @event.user_events.count %>
      <% participants_count = @event.user_events.where(status: 'going').count %>
      <% interested_count = @event.user_events.where(status: 'maybe').count %>

      <% guests_text = guests_count == 1 ? 'invité' : 'invités' %>
      <% participants_text = participants_count == 1 ? 'participant' : 'participants' %>
      <% interested_text = interested_count == 1 ? 'intéressé' : 'intéressés' %>

      <%= "#{guests_count} #{guests_text} - #{pluralize(participants_count, participants_text)} - #{pluralize(interested_count, interested_text)}" %>
      <span><i class="fa-solid fa-user-plus px-1"></i></span>
    <% end %>
  </div>

<%# organisateurs %>
  <% planners = @event.user_events.where(planner: true) %>
  <p class="mb-3"><i class="fa-solid fa-user"></i> Organisé par
    <% planners.each_with_index do |planner, index| %>
      <%= "#{planner.user.first_name}" %><%= index == planners.size - 1 ? '' : ',' %>
    <% end %>
  </p>


<%# lieu %>
<%= render "shared/show/edit_place" %>

<%# bouton de partage de l'évènement TODO %>

  <!-- Créer nouveaux sondages et listes -->

  <div class="mb-3">
    <%= link_to new_event_survey_path(@event), class: "link" do %>
      <i class="fa-solid fa-circle-plus"></i> Créer un nouveau sondage
    <% end %>
  </div>

  <% if @event.user_events.where(planner: true) %>
    <div class="mb-3">
      <%= link_to new_event_todo_list_path(@event), class: "link" do %>
        <i class="fa-solid fa-circle-plus"></i> Créer une to-do list
      <% end %>
    </div>
  <% end %>

  <%# affichage des surveys  %>

  <div class="mt-4">
    <% @event.surveys.each do |survey| %>
      <% if !survey.answers.present? %>
        <div class="mb-3 survey-card">
          <%= link_to survey_path(survey), class: "link d-flex justify-content-between" do %>
            <div>
              <p><%= survey.question %></p>
              <p class="text-danger">Sondage à compléter</p>
            </div>
            <div class="text-center chevron">
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="mb-3 survey-card">
          <%= link_to survey_path(survey), class: "link d-flex justify-content-between" do %>
              <div>
                <p class="survey-question"><%= survey.question %></p>
                <% if survey.deadline < Date.today %>
                  <p class="survey-infos">Sondage terminé <i class="fa-solid fa-check text-success"></i></p>
                <% elsif survey.deadline > Date.today %>
                  <p class="survey-infos"><i class="fa-solid fa-hourglass-start"></i> Fin du sondage dans <%= pluralize((survey.deadline - Date.today).to_i, "jour") %></p>
                <% else %>
                  <p class="survey-infos"><i class="fa-solid fa-hourglass-half"></i> Fin du sondage aujourd'hui</p>
                <% end %>
              </div>
              <div class="text-center chevron">
                <i class="fa-solid fa-chevron-right"></i>
              </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

<%# affichage des listes %>
   <% @event.todo_lists.each do |todo| %>
  <%= link_to todo_list_path(todo), class: "link" do %>
    <div class="mb-3 survey-card">
      <%= todo.title %>
    </div>
  <% end %>
<% end %>


<%# Description %>
<%= render 'shared/show/edit_description' %>

</div>
